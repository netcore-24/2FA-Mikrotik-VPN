# Диаграммы работы системы

## Telegram: сообщения и условия показа

См. отдельный документ: `telegram_messages_flow.md`.

## 🎯 Полный цикл работы системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЭТАП 0: Подготовка (Администратор)                       │
└─────────────────────────────────────────────────────────────────────────────┘

    MikroTik Router (WebFig/WinBox)
    ├─ User Manager → Add User
    │  ├─ username: vpn_user_ivan
    │  ├─ password: SecurePass123
    │  └─ profile: default
    │
    └─ Firewall → Add Rule (опционально)
       ├─ comment: vpn_user_ivan
       ├─ action: accept
       └─ disabled: yes (по умолчанию выключено)

┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЭТАП 1: Регистрация пользователя                         │
└─────────────────────────────────────────────────────────────────────────────┘

    Telegram Bot                Backend API              Database
         │                           │                       │
    [/register]                      │                       │
         │──────────────────────────>│                       │
         │                           │                       │
         │ "Введите ФИО"             │                       │
         │<──────────────────────────│                       │
         │                           │                       │
    [Иван Петров]                    │                       │
         │──────────────────────────>│                       │
         │                           │                       │
         │                    create_registration_request    │
         │                           │──────────────────────>│
         │                           │                  INSERT INTO
         │                           │              registration_requests
         │                           │                  (status='pending')
         │                           │<──────────────────────│
         │ "Заявка отправлена"       │                       │
         │<──────────────────────────│                       │

┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЭТАП 2: Одобрение администратором                        │
└─────────────────────────────────────────────────────────────────────────────┘

    Admin Web UI                Backend API              Database
         │                           │                       │
    [Запросы на регистрацию]         │                       │
         │────── GET /api/registration-requests ────>        │
         │                           │───── SELECT * ───────>│
         │                           │        FROM           │
         │                           │  registration_requests│
         │                           │<──────────────────────│
         │<──────────────────────────│                       │
         │                           │                       │
    [Просмотр: Иван Петров]          │                       │
    [Telegram: 123456789]            │                       │
         │                           │                       │
    [Кнопка "Одобрить"]              │                       │
         │─── POST /api/registration-requests/{id}/approve ─>│
         │                           │                       │
         │                    approve_registration_request    │
         │                           │──────────────────────>│
         │                           │  1. INSERT INTO users │
         │                           │     (status='approved')│
         │                           │  2. UPDATE            │
         │                           │     registration_requests│
         │                           │     status='approved' │
         │                           │<──────────────────────│
         │<──────────────────────────│                       │
         │                           │                       │
         │                    send_telegram_notification     │
         ├────────────────────>Telegram API                  │
                                      │                       │
                              [Ваша заявка одобрена!]        │
                                 ↓ (to user)                 │

┌─────────────────────────────────────────────────────────────────────────────┐
│                ЭТАП 3: Привязка MikroTik аккаунта                           │
└─────────────────────────────────────────────────────────────────────────────┘

    Admin Web UI                Backend API         MikroTik Router
         │                           │                       │
    [Страница "Пользователи"]        │                       │
    [Иван Петров] [Редактировать]    │                       │
         │                           │                       │
    [Модальное окно]                 │                       │
    ┌──────────────────────────┐     │                       │
    │ MikroTik аккаунт #1:     │     │                       │
    │ [vpn_user_ivan]          │     │                       │
    │ MikroTik аккаунт #2:     │     │                       │
    │ [                    ]   │     │                       │
    │ [Сохранить] [Отмена]     │     │                       │
    └──────────────────────────┘     │                       │
         │                           │                       │
    [Сохранить]                      │                       │
         │─── PUT /api/users/{id} ──>│                       │
         │   { mikrotik_usernames:   │                       │
         │     ["vpn_user_ivan"] }   │                       │
         │                           │                       │
         │              Проверка существования пользователя  │
         │                           │─── SSH/REST API ─────>│
         │                           │  /user-manager user   │
         │                           │  print detail         │
         │                           │<──────────────────────│
         │                           │  [vpn_user_ivan] ✓    │
         │                           │                       │
         │              set_user_mikrotik_usernames          │
         │                           │──────────────────────>│
         │                           │  INSERT INTO          │
         │                           │  user_mikrotik_accounts│
         │                           │<──────────────────────│
         │<──────────────────────────│                       │
    [✓ Сохранено]                    │                       │

┌─────────────────────────────────────────────────────────────────────────────┐
│                    ЭТАП 4: Запрос VPN подключения                           │
└─────────────────────────────────────────────────────────────────────────────┘

    Telegram Bot           Backend API        MikroTik Router    Database
         │                      │                     │              │
    [/request_vpn]              │                     │              │
         │─────────────────────>│                     │              │
         │                      │                     │              │
         │           Проверка статуса пользователя   │              │
         │                      │─────────────────────────────── SELECT
         │                      │                     │          FROM users
         │                      │<────────────────────────────────────│
         │                      │ (status='approved') ✓              │
         │                      │                     │              │
         │           Проверка привязанных аккаунтов  │              │
         │                      │─────────────────────────────── SELECT
         │                      │                     │          FROM
         │                      │                     │   user_mikrotik_accounts
         │                      │<────────────────────────────────────│
         │                      │ [vpn_user_ivan] ✓  │              │
         │                      │                     │              │
         │           🔓 АКТИВАЦИЯ ПОЛЬЗОВАТЕЛЯ В MIKROTIK            │
         │                      │                     │              │
         │                enable_user_manager_user    │              │
         │                      │─── SSH/REST API ───>│              │
         │                      │ /user-manager user  │              │
         │                      │ set [find name=     │              │
         │                      │ "vpn_user_ivan"]    │              │
         │                      │ disabled=no         │              │
         │                      │<────────────────────│              │
         │                      │  ✓ Activated        │              │
         │                      │                     │              │
         │                create_vpn_session          │              │
         │                      │─────────────────────────────── INSERT
         │                      │                     │          INTO
         │                      │                     │      vpn_sessions
         │                      │                     │  (status='requested',
         │                      │                     │   mikrotik_username=
         │                      │                     │   'vpn_user_ivan')
         │                      │<────────────────────────────────────│
         │                      │                     │              │
         │ ✅ Аккаунт активирован!│                    │              │
         │ Подключайтесь к VPN  │                    │              │
         │<─────────────────────│                     │              │

┌─────────────────────────────────────────────────────────────────────────────┐
│                ЭТАП 5: Подключение пользователя к VPN                       │
└─────────────────────────────────────────────────────────────────────────────┘

    Пользователь (ПК/телефон)        MikroTik Router
         │                                  │
    [Настройки VPN]                        │
    ├─ Сервер: vpn.example.com            │
    ├─ Тип: L2TP/IPsec                    │
    ├─ Логин: vpn_user_ivan               │
    └─ Пароль: SecurePass123              │
         │                                  │
    [Подключиться]                         │
         │────── VPN Connection Request ───>│
         │                                  │
         │        Authentication            │
         │<─────────────────────────────────│
         │                                  │
         │────── Credentials ───────────────>│
         │        (vpn_user_ivan /          │
         │         SecurePass123)           │
         │                                  │
         │        ✓ Connected               │
         │<─────────────────────────────────│
         │                                  │
    [✓ VPN подключен]                      │

┌─────────────────────────────────────────────────────────────────────────────┐
│            ЭТАП 6: Обнаружение подключения (мониторинг)                     │
└─────────────────────────────────────────────────────────────────────────────┘

    Scheduler Service          Backend API        MikroTik Router
    (каждые 5 минут)               │                     │
         │                         │                     │
    [check_vpn_connections()]      │                     │
         │────────────────────────>│                     │
         │                         │                     │
         │            Получить активные подключения      │
         │                         │─── SSH/REST API ───>│
         │                         │ /user-manager active│
         │                         │ print detail        │
         │                         │<────────────────────│
         │                         │ user: vpn_user_ivan │
         │                         │ caller-id: 1.2.3.4  │
         │                         │                     │
         │            Сравнить с сессиями БД             │
         │                         │─────────────────────────── SELECT
         │                         │                     │   FROM
         │                         │                     │   vpn_sessions
         │                         │                     │   WHERE
         │                         │                     │   status='requested'
         │                         │<──────────────────────────────────│
         │                         │ session_id: abc123  │            │
         │                         │ mikrotik_username:  │            │
         │                         │   vpn_user_ivan ✓   │            │
         │                         │                     │            │
         │            Обновить статус сессии             │            │
         │                         │─────────────────────────── UPDATE
         │                         │                     │   vpn_sessions
         │                         │                     │   SET status=
         │                         │                     │   'connected'
         │                         │<──────────────────────────────────│

┌─────────────────────────────────────────────────────────────────────────────┐
│            ЭТАП 7: Двухфакторное подтверждение (2FA)                        │
└─────────────────────────────────────────────────────────────────────────────┘

    Scheduler/Backend      Telegram Bot          User          Database
         │                      │                  │               │
    [session status='connected']                  │               │
         │                      │                  │               │
    send_confirmation_request   │                  │               │
         │─────────────────────>│                  │               │
         │                      │                  │               │
         │      ❓ Обнаружено подключение          │               │
         │         Это вы?                         │               │
         │         [✅ Да] [❌ Нет]                 │               │
         │                      │─────────────────>│               │
         │                      │                  │               │
         │                      │    [✅ Да, это я]│               │
         │                      │<─────────────────│               │
         │<─────────────────────│                  │               │
         │                      │                  │               │
    mark_session_as_confirmed   │                  │               │
         │────────────────────────────────────────────────────── UPDATE
         │                      │                  │          vpn_sessions
         │                      │                  │          SET status=
         │                      │                  │          'confirmed'
         │                      │                  │          → 'active'
         │                      │                  │<──────────────────────│
         │                      │                  │               │
    enable_firewall_rule (опционально)            │               │
         │─── SSH ──────────────────────────────> MikroTik        │
         │ /ip firewall filter enable              │               │
         │ [find comment="vpn_user_ivan"]          │               │
         │<───────────────────────────────────────────             │
         │                      │                  │               │
    set_expiry_timer            │                  │               │
         │ (expires_at = now + 6 hours)            │               │
         │────────────────────────────────────────────────────── UPDATE
         │                      │                  │          vpn_sessions
         │                      │                  │<──────────────────────│
         │                      │                  │               │
         │      ✅ VPN активирован!                 │               │
         │                      │─────────────────>│               │

┌─────────────────────────────────────────────────────────────────────────────┐
│                ЭТАП 8: Напоминание о продлении                              │
└─────────────────────────────────────────────────────────────────────────────┘

    [Через 6 часов]

    Scheduler Service      Telegram Bot          User          Database
         │                      │                  │               │
    [check expired sessions]    │                  │               │
         │─────────────────────────────────────────────────── SELECT
         │                      │                  │          WHERE
         │                      │                  │          expires_at <
         │                      │                  │          NOW()
         │                      │                  │<──────────────────────│
         │                      │                  │    session: abc123    │
         │                      │                  │               │
    send_vpn_reminder           │                  │               │
         │─────────────────────>│                  │               │
         │                      │                  │               │
         │      ⏰ Напоминание о VPN                │               │
         │         Продолжить работу?              │               │
         │         [✅ Да] [❌ Нет]                 │               │
         │                      │─────────────────>│               │
         │                      │                  │               │
         │                      │  [✅ Да, продолжить]              │
         │                      │<─────────────────│               │
         │<─────────────────────│                  │               │
         │                      │                  │               │
    extend_session              │                  │               │
         │────────────────────────────────────────────────────── UPDATE
         │                      │                  │          vpn_sessions
         │                      │                  │          expires_at=
         │                      │                  │          NOW() + 6h
         │                      │                  │<──────────────────────│
         │                      │                  │               │
         │      ✅ Сессия продлена                  │               │
         │                      │─────────────────>│               │

┌─────────────────────────────────────────────────────────────────────────────┐
│                ЭТАП 9: Отключение (по запросу или таймауту)                 │
└─────────────────────────────────────────────────────────────────────────────┘

    Backend               MikroTik Router         Database
         │                       │                    │
    disconnect_vpn_session       │                    │
         │                       │                    │
    [1] Отключить firewall rule  │                    │
         │─── SSH/REST API ─────>│                    │
         │ /ip firewall filter   │                    │
         │ disable [find comment=│                    │
         │ "vpn_user_ivan"]      │                    │
         │<──────────────────────│                    │
         │                       │                    │
    [2] Отключить пользователя   │                    │
         │─── SSH/REST API ─────>│                    │
         │ /user-manager user    │                    │
         │ set [find name=       │                    │
         │ "vpn_user_ivan"]      │                    │
         │ disabled=yes          │                    │
         │<──────────────────────│                    │
         │  🔒 User disabled     │                    │
         │                       │                    │
    [3] Обновить статус сессии   │                    │
         │───────────────────────────────────────── UPDATE
         │                       │               vpn_sessions
         │                       │               SET status=
         │                       │               'disconnected'
         │                       │<─────────────────────────────│
         │                       │                    │
    send_notification            │                    │
         └──> Telegram Bot ──> User                  │
              ❌ VPN отключен                         │
```

## 🔄 Состояния VPN сессии

```
┌───────────┐
│ REQUESTED │  ← Пользователь запросил VPN
│           │    Аккаунт активирован в MikroTik
└─────┬─────┘    
      │ Мониторинг обнаруживает подключение (каждые 5 мин)
      ↓
┌───────────┐
│ CONNECTED │  ← Подключение обнаружено
│           │    Отправлено уведомление с кнопками
└─────┬─────┘    Таймаут: 5 минут
      │
      ├─────> [Нет] или [Таймаут] ──> DISCONNECTED
      │                                (разрыв соединения)
      │
      │ Пользователь нажал "Да"
      ↓
┌───────────┐
│ CONFIRMED │  ← Подтверждено пользователем
│           │    Firewall правило включается
└─────┬─────┘    
      │ Сразу переводится в
      ↓
┌───────────┐
│  ACTIVE   │  ← Сессия активна
│           │    Таймер до напоминания: 6 часов
└─────┬─────┘    
      │ По истечении времени
      ↓
┌──────────────┐
│REMINDER_SENT │  ← Напоминание отправлено
│              │    Таймаут: 10 минут
└──────┬───────┘    
       │
       ├─────> [Продолжить] ──> ACTIVE (продление)
       │
       ├─────> [Отключить] или [Таймаут] ──> DISCONNECTED
       │
       └─────> [Долгое время неактивен] ──> EXPIRED
```

## 📊 Роли и ответственность компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                  Компонент: Администратор                   │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│ • Создание пользователей в MikroTik User Manager (вручную) │
│ • Настройка firewall правил (вручную)                       │
│ • Одобрение регистраций пользователей                       │
│ • Привязка MikroTik usernames к пользователям системы       │
│ • Передача паролей пользователям (безопасным способом)      │
│ • Мониторинг системы через веб-интерфейс                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  Компонент: Backend API                     │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│ • Обработка регистраций                                     │
│ • Управление сессиями VPN                                   │
│ • Включение/отключение пользователей в MikroTik             │
│ • Включение/отключение firewall правил                      │
│ • Планирование и выполнение мониторинга                     │
│ • Хранение состояния в базе данных                          │
│ • Предоставление API для веб-интерфейса                     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  Компонент: Telegram Bot                    │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│ • Прием регистраций от пользователей                        │
│ • Обработка запросов на VPN                                 │
│ • Отправка уведомлений о подключениях (2FA)                 │
│ • Прием подтверждений/отклонений                            │
│ • Отправка напоминаний о продлении                          │
│ • Управление активными сессиями пользователя                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  Компонент: MikroTik Router                 │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│ • Хранение учетных записей User Manager                     │
│ • Аутентификация VPN подключений                            │
│ • Применение firewall правил                                │
│ • Предоставление информации о подключениях через SSH/API    │
│ • Управление VPN туннелями                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Компонент: Scheduler Service                   │
├─────────────────────────────────────────────────────────────┤
│ Ответственность:                                            │
│ • Мониторинг VPN подключений (каждые 5 минут)              │
│ • Проверка истекших сессий (каждые 15 минут)               │
│ • Отправка напоминаний (каждый час)                         │
│ • Очистка старых данных (ежедневно)                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔐 Безопасность и ограничения

```
┌──────────────────────────────────────────────────────────────┐
│              ЧТО СИСТЕМА ДЕЛАЕТ                              │
├──────────────────────────────────────────────────────────────┤
│ ✅ Включает/отключает существующих пользователей MikroTik    │
│ ✅ Включает/отключает существующие firewall правила          │
│ ✅ Мониторит активные VPN подключения                        │
│ ✅ Отправляет уведомления и запросы подтверждения           │
│ ✅ Управляет состоянием сессий                              │
│ ✅ Хранит связь между Telegram пользователями и MikroTik    │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│             ЧТО СИСТЕМА НЕ ДЕЛАЕТ                            │
├──────────────────────────────────────────────────────────────┤
│ ❌ НЕ создает новых пользователей в MikroTik                 │
│ ❌ НЕ изменяет пароли пользователей                          │
│ ❌ НЕ хранит пароли VPN                                      │
│ ❌ НЕ создает firewall правила (только управляет)            │
│ ❌ НЕ изменяет профили/настройки пользователей MikroTik      │
│ ❌ НЕ выдает учетные данные пользователям автоматически      │
└──────────────────────────────────────────────────────────────┘
```

---

**Дата:** 2026-01-10  
**Версия:** 1.0

