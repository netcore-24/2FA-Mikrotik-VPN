# Руководство по развертыванию

Подробное руководство по установке и развертыванию системы на Debian 12-13.

## Требования

- ОС: Debian 12 (Bookworm) или Debian 13 (Trixie)
- Python 3.11+ (входит в Debian 12+)
- SQLite 3.x (встроен в Python)
- Минимум 512MB RAM (рекомендуется 1GB+)
- Минимум 1GB свободного места на диске

## Автоматическая установка

Проект содержит скрипт автоматической установки `install.sh`, который выполнит всю необходимую настройку.

### Шаги установки:

1. Клонирование или распаковка проекта:
```bash
cd /opt
git clone <repository-url> mikrotik-2fa-vpn
# или
tar -xzf mikrotik-2fa-vpn.tar.gz
cd mikrotik-2fa-vpn
```

2. Запуск скрипта установки:
```bash
chmod +x install.sh
sudo ./install.sh
```

Скрипт выполнит:
- Проверку версии ОС
- Установку системных пакетов
- Создание виртуального окружения Python
- Установку всех Python зависимостей из requirements.txt
- Установку Node.js зависимостей (если требуется)
- Создание необходимых директорий
- Настройку прав доступа
- Создание systemd service (опционально)

3. Настройка переменных окружения:
```bash
cp .env.example .env
nano .env
```

Заполните необходимые переменные:
- TELEGRAM_BOT_TOKEN
- DATABASE_URL (опционально, по умолчанию используется SQLite)
- SECRET_KEY
- и другие настройки

4. Инициализация базы данных:
База данных SQLite создается автоматически при первом запуске.

5. Запуск приложения:
```bash
# Ручной запуск
./scripts/start.sh

# Или через systemd
sudo systemctl start mikrotik-2fa-vpn
sudo systemctl enable mikrotik-2fa-vpn
```

6. Первоначальная настройка через мастер настройки:
После запуска приложения откройте веб-интерфейс в браузере.
При первом входе автоматически запустится мастер настройки (Setup Wizard), 
который поможет настроить систему пошагово:

- Основная информация (название, язык, часовой пояс)
- Безопасность (секретный ключ, создание первого администратора)
- Telegram Bot (токен бота, тест подключения)
- MikroTik Router (подключение к роутеру, инструкции по настройке)
- Уведомления (настройка уведомлений администратору)
- Дополнительные настройки (опционально)

Мастер настройки содержит подробные инструкции и подсказки на каждом шаге.
Вы можете запустить мастер настройки в любой момент из меню "Настройки" -> "Мастер настройки".

Подробнее о мастере настройки: `setup_wizard.md`

## Ручная установка

Если требуется ручная установка:

### 1. Установка системных пакетов

```bash
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git
```

### 2. Установка Python зависимостей

```bash
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 3. Установка Frontend зависимостей (если требуется сборка)

```bash
cd frontend
npm install
npm run build
cd ..
```

### 4. Настройка переменных окружения

```bash
cp .env.example .env
# Отредактируйте .env файл
```

### 5. Запуск миграций

Миграции выполняются автоматически при первом запуске.

## Зависимости проекта

Все зависимости включены в проект:

- **requirements.txt** - все Python зависимости с фиксированными версиями
- **package.json** - все Frontend зависимости (если требуется)
- **install.sh** - список системных пакетов для Debian

## Резервное копирование

Для резервного копирования базы данных SQLite:

```bash
# Ручное резервное копирование
./scripts/backup_db.sh

# Автоматическое резервное копирование настраивается через cron
```

База данных SQLite - это файл, поэтому резервное копирование выполняется простым копированием файла.

## Обновление

Для обновления системы:

```bash
git pull  # или обновление файлов проекта
./scripts/update.sh
```

## Структура базы данных

База данных SQLite хранится в файле `data/mikrotik_2fa.db` (по умолчанию).

Все таблицы создаются автоматически при первом запуске через миграции SQLAlchemy.

## Troubleshooting

### Проблемы с правами доступа

```bash
sudo chown -R $USER:$USER /opt/mikrotik-2fa-vpn
chmod +x scripts/*.sh
```

### Проблемы с зависимостями

```bash
source venv/bin/activate
pip install --upgrade -r requirements.txt
```

### Проблемы с базой данных

Проверьте права доступа к файлу базы данных и директории data/:

```bash
ls -la data/
```

