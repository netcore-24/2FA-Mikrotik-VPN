# Интернационализация (i18n)

Документация по системе интернационализации проекта.

## Обзор

Проект поддерживает несколько языков для интерфейса и сообщений. В настоящее время поддерживаются:
- Русский (ru) - язык по умолчанию
- Английский (en)

## Определение языка

Система определяет язык пользователя в следующем порядке приоритета:

1. **Параметр запроса** `?lang=ru` или `?lang=en`
2. **Заголовок HTTP** `Accept-Language` (например, `Accept-Language: ru-RU,ru;q=0.9,en;q=0.8`)
3. **Настройка по умолчанию** из переменной окружения `LANGUAGE` или из настроек приложения

## Использование в API

### Dependency для получения языка

В любом endpoint можно использовать dependency для получения текущего языка:

```python
from backend.api.i18n_dependencies import get_language, get_translate

@router.get("/example")
async def example(
    language: str = Depends(get_language),
    t=Depends(get_translate),
):
    message = t("auth.login.title")
    return {"message": message, "language": language}
```

### Использование переводов

Функция `t()` автоматически использует язык из запроса:

```python
# Простой перевод
message = t("auth.login.title")

# Перевод с параметрами
message = t("validation.min_length", min_length=8)
```

## API Endpoints

### GET /api/i18n/languages

Получить список поддерживаемых языков.

**Ответ:**
```json
{
  "supported_languages": ["ru", "en"],
  "default_language": "ru"
}
```

### GET /api/i18n/translations

Получить все переводы для текущего языка (определяется автоматически из запроса).

**Параметры запроса:**
- `lang` (опционально) - принудительно указать язык (например, `?lang=en`)

**Ответ:**
```json
{
  "language": "ru",
  "translations": {
    "auth": {
      "login": {
        "title": "Вход в систему",
        ...
      }
    },
    ...
  }
}
```

### GET /api/i18n/translate/{key}

Получить перевод конкретного ключа.

**Пример:** `/api/i18n/translate/auth.login.title`

**Ответ:**
```json
{
  "key": "auth.login.title",
  "translation": "Вход в систему",
  "language": "ru"
}
```

## Структура файлов переводов

Переводы хранятся в JSON файлах в директории `locales/{language}/messages.json`:

```
locales/
├── ru/
│   └── messages.json
└── en/
    └── messages.json
```

### Формат ключей

Ключи переводов используют точечную нотацию для иерархической структуры:

```json
{
  "auth": {
    "login": {
      "title": "Вход в систему",
      "success": "Успешный вход в систему"
    }
  }
}
```

Использование: `t("auth.login.title")` → `"Вход в систему"`

### Параметры в переводах

Поддерживается подстановка параметров через `{parameter_name}`:

```json
{
  "validation": {
    "min_length": "Минимальная длина: {min_length} символов"
  }
}
```

Использование: `t("validation.min_length", min_length=8)` → `"Минимальная длина: 8 символов"`

## Использование на фронтенде

### Получение всех переводов

```javascript
// При инициализации приложения
const response = await fetch('/api/i18n/translations?lang=ru');
const { language, translations } = await response.json();

// Использование
const message = translations.auth.login.title;
```

### Изменение языка

```javascript
// Установить язык через параметр запроса
const response = await fetch('/api/i18n/translations?lang=en');
```

## Использование в Telegram боте

Для Telegram бота язык определяется из настроек пользователя или используется язык по умолчанию:

```python
from backend.utils.i18n import translate

# Использование с явным указанием языка
message = translate("telegram.bot.start", language="ru")

# Использование языка по умолчанию
message = translate("telegram.bot.start")
```

## Добавление нового языка

1. Создайте директорию для нового языка:
   ```bash
   mkdir -p locales/es  # например, для испанского
   ```

2. Скопируйте структуру из существующего файла переводов:
   ```bash
   cp locales/en/messages.json locales/es/messages.json
   ```

3. Переведите содержимое файла на новый язык

4. Добавьте язык в список поддерживаемых:
   ```python
   # backend/utils/i18n.py
   SUPPORTED_LANGUAGES = ["ru", "en", "es"]
   ```

## Кэширование

Переводы автоматически кэшируются в памяти после первой загрузки для оптимизации производительности. При необходимости можно очистить кэш:

```python
from backend.utils.i18n import clear_cache
clear_cache()
```

## Лучшие практики

1. **Используйте иерархическую структуру ключей** - это помогает организовать переводы
2. **Используйте осмысленные имена ключей** - `auth.login.title` лучше, чем `msg1`
3. **Добавляйте параметры для динамических значений** - используйте форматирование строк
4. **Всегда предоставляйте переводы для всех поддерживаемых языков**
5. **Используйте fallback** - если перевод не найден, возвращается сам ключ

