# Как работает система

Ниже описан реальный рабочий сценарий — от подготовки на MikroTik до подключения пользователя и контроля сессии.

## 1) Подготовка на MikroTik

1. Администратор **создаёт VPN‑пользователя на MikroTik** (User Manager или PPP secret — зависит от конфигурации роутера).
2. При необходимости заранее создаётся/настраивается **firewall‑правило** с комментарием, содержащим `2FA` (если планируется “доп. защита”).

Важно: система **не обязана** создавать пользователей на MikroTik (может управлять существующими). В текущей конфигурации проекта предусмотрено управление и синхронизация, но базовая логика всегда опирается на учётки на роутере.

## 2) Регистрация пользователя

1. Пользователь пишет в **Telegram‑бот** и отправляет заявку на регистрацию.
2. Администратор открывает веб‑интерфейс → **Пользователи** и **одобряет** заявку.

## 3) Привязка MikroTik‑аккаунтов

1. Администратор открывает пользователя → **Редактировать**.
2. Указывает до **двух** MikroTik username (например `vpn_user_ivan`).
3. Сохраняет изменения.

## 4) Запрос доступа и подключение к VPN

1. Пользователь запрашивает доступ через Telegram‑бота (команда/кнопка “получить VPN”).
2. Система создаёт/обновляет запись о VPN‑сессии и **разрешает подключение** (активация на MikroTik — в зависимости от выбранной схемы).
3. Пользователь подключается к VPN стандартным клиентом (Windows/macOS/Linux/Android/iOS), используя логин/пароль от учётки MikroTik.

## 5) Контроль активной сессии и “доп. защита”

1. Система периодически проверяет активные подключения на MikroTik (User Manager sessions / PPP active).
2. Если включена **доп. защита**, пользователю в Telegram приходит подтверждение “Это вы подключились?”.
3. После подтверждения система может **включить firewall‑правило** (если оно привязано) и пометить сессию как активную.

## 6) Завершение и продление

1. Сессия имеет лимит по времени (настраивается в UI).
2. Перед истечением система отправляет напоминание о продлении.
3. Если пользователь не продлевает — сессия завершается, а доступ может быть отозван (в зависимости от политики).
