================================================================================
ПЛАН РАЗРАБОТКИ ПРИЛОЖЕНИЯ ДВУХФАКТОРНОЙ АУТЕНТИФИКАЦИИ ДЛЯ VPN MIKROTIK
================================================================================

ВЕРСИЯ: 1.2
ДАТА: 2024
ОБНОВЛЕНИЯ: 
- v1.1: Использование SQLite вместо PostgreSQL, поддержка Debian 12-13, все зависимости включены в проект
- v1.2: Добавлен мастер настройки с пошаговым руководством, добавлено управление базой данных (скачивание/загрузка) из веб-интерфейса

================================================================================
1. ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА
================================================================================

Проект представляет собой систему двухфакторной аутентификации для VPN 
подключений на роутерах MikroTik, использующую Telegram бот или Mini-App 
для подтверждения подключений и управления доступом через веб-интерфейс 
администратора.

Основные цели:
- Безопасное подключение к VPN с подтверждением через Telegram
- Автоматическое управление пользователями и правилами firewall в MikroTik
- Гибкая настройка всех параметров через веб-консоль администратора
- Поддержка многопользовательского режима

================================================================================
2. АРХИТЕКТУРА СИСТЕМЫ
================================================================================

2.1 Компоненты системы:

┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   Telegram Bot  │◄────►│   Backend API   │◄────►│  Web Admin UI   │
│   / Mini-App    │      │   (FastAPI)     │      │   (React/Vue)   │
└─────────────────┘      └─────────────────┘      └─────────────────┘
                                │
                                │ SSH/REST API
                                ▼
                         ┌─────────────────┐
                         │   MikroTik      │
                         │   Router        │
                         └─────────────────┘
                                │
                                ▼
                         ┌─────────────────┐
                         │   Database      │
                         │   (SQLite)      │
                         └─────────────────┘

2.2 Модули Backend:
- API Server (REST API для веб-интерфейса)
- Telegram Bot Service (обработка команд и уведомлений)
- MikroTik Service (управление через SSH/REST API)
- User Management Service (управление пользователями)
- Notification Service (уведомления в Telegram)
- Scheduler Service (отложенные задачи, напоминания)
- Authentication Service (аутентификация администраторов)
- Configuration Service (управление настройками)

================================================================================
3. АЛГОРИТМ РАБОТЫ СИСТЕМЫ
================================================================================

3.1 Этап 1: Регистрация нового пользователя

Шаг 1: Пользователь открывает Telegram бот или Mini-App
Шаг 2: Пользователь нажимает кнопку "Зарегистрироваться"
Шаг 3: Бот запрашивает у пользователя:
   - ФИО (полное имя)
   - Контактный телефон
   - Email (опционально)
   - Примечание/комментарий (опционально)
Шаг 4: Система создает запрос на регистрацию со статусом "pending"
Шаг 5: Уведомление отправляется администратору через:
   - Telegram уведомление (если настроено)
   - Email уведомление (если настроено)
   - Веб-интерфейс (видимость в списке запросов)

3.2 Этап 2: Одобрение регистрации администратором

Шаг 1: Администратор входит в веб-консоль
Шаг 2: Просматривает список запросов на регистрацию
Шаг 3: Проверяет данные пользователя (ФИО, телефон, Telegram ID)
Шаг 4: Принимает решение:
   - Одобрить: устанавливает статус "approved"
   - Отклонить: устанавливает статус "rejected" с указанием причины
Шаг 5: При одобрении:
   - В системе создается учетная запись пользователя
   - Привязывается Telegram ID к учетной записи
   - Пользователю отправляется уведомление об одобрении

3.3 Этап 3: Запрос на подключение к VPN

Шаг 1: Пользователь открывает Telegram бот
Шаг 2: Нажимает кнопку "Подключиться к VPN"
Шаг 3: Система проверяет:
   - Статус пользователя (одобрен ли)
   - Текущее состояние VPN (не подключен ли уже)
   - Наличие активной сессии
Шаг 4: Если проверки пройдены:
   - В MikroTik User Manager создается/активируется пользователь
   - Генерируются/обновляются учетные данные VPN
   - Пользователю отправляется информация для подключения:
     * Сервер VPN
     * Логин
     * Пароль
     * Инструкция по подключению
Шаг 5: Если проверки не пройдены - отправляется сообщение с причиной

3.4 Этап 4: Подключение к VPN и подтверждение

Шаг 1: Пользователь подключается к VPN через стандартные средства ОС
Шаг 2: MikroTik регистрирует подключение пользователя
Шаг 3: Система отслеживает подключение через:
   - Периодический опрос активных сессий через MikroTik API
   - Анализ логов подключений
   - Мониторинг состояния пользователя в User Manager
Шаг 4: При обнаружении подключения:
   - Система извлекает имя пользователя из User Manager MikroTik
   - Формируется уведомление с именем пользователя
   - Отправляется вопрос в Telegram: "Это вы подключились? [Имя пользователя]"
   - Создается таймер ожидания подтверждения (настраиваемое время, по умолчанию 5 минут)
Шаг 5: Пользователь получает уведомление и нажимает:
   - "Да" - подтверждает подключение
   - "Нет" - отклоняет подключение
Шаг 6: При нажатии "Да":
   - Включается правило firewall для этого пользователя в MikroTik
   - Правило ищется по комментарию, настраиваемому для пользователя
   - Запускается таймер для напоминания (4-8 часов, настраиваемо)
   - Пользователю отправляется подтверждение успешной активации
Шаг 7: При нажатии "Нет" или истечении таймера:
   - Отключается пользователь в User Manager
   - Отключается правило firewall
   - Разрывается VPN соединение
   - Пользователю отправляется уведомление об отключении

3.5 Этап 5: Напоминание о продолжении работы

Шаг 1: По истечении заданного времени (4-8 часов)
Шаг 2: Пользователю отправляется уведомление:
   "Хотите продолжить работу в VPN? [Имя пользователя]"
Шаг 3: Пользователь отвечает:
   - "Да" - продлевается время работы еще на заданный интервал
   - "Нет" - отключается пользователь и правило firewall
Шаг 4: Если пользователь не отвечает в течение заданного времени (по умолчанию 10 минут):
   - Автоматически отключается пользователь
   - Отключается правило firewall
   - Разрывается VPN соединение

================================================================================
4. ТЕХНИЧЕСКИЙ СТЕК
================================================================================

4.1 Backend:
- Язык: Python 3.11+
- Framework: FastAPI
- Database: SQLite 3 (встроенная)
- ORM: SQLAlchemy 2.0+
- Telegram Bot: python-telegram-bot или aiogram 3.x
- MikroTik взаимодействие: 
  - SSH: paramiko или asyncssh
  - REST API: requests или aiohttp
- Планировщик задач: APScheduler или Celery
- Аутентификация: JWT токены
- Логирование: logging + structlog

4.2 Frontend (Web Admin):
- Framework: React 18+ или Vue 3+
- UI библиотека: Material-UI / Ant Design / Vuetify
- HTTP клиент: axios или fetch
- State management: Redux / Zustand / Pinia
- Формы: React Hook Form / Vee-Validate

4.3 Telegram:
- Bot Framework: python-telegram-bot или aiogram
- Mini-App: WebView в Telegram или отдельное веб-приложение

4.4 Инфраструктура:
- Веб-сервер: Uvicorn / Gunicorn
- Reverse Proxy: Nginx (опционально)
- Контейнеризация: Не используется (по предпочтениям пользователя)

================================================================================
5. СТРУКТУРА БАЗЫ ДАННЫХ
================================================================================

5.1 Таблицы:

users (Пользователи системы)
- id (PK, UUID)
- telegram_id (BIGINT, UNIQUE, NOT NULL)
- full_name (VARCHAR(255))
- phone (VARCHAR(20))
- email (VARCHAR(255))
- status (ENUM: pending, approved, rejected, active, inactive)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
- rejected_reason (TEXT, NULL)
- approved_by (FK -> admins.id)
- approved_at (TIMESTAMP, NULL)

admins (Администраторы)
- id (PK, UUID)
- username (VARCHAR(100), UNIQUE)
- email (VARCHAR(255), UNIQUE)
- password_hash (VARCHAR(255))
- full_name (VARCHAR(255))
- is_active (BOOLEAN)
- is_super_admin (BOOLEAN)
- created_at (TIMESTAMP)
- last_login (TIMESTAMP, NULL)

vpn_sessions (VPN Сессии)
- id (PK, UUID)
- user_id (FK -> users.id)
- mikrotik_username (VARCHAR(100))
- status (ENUM: requested, connected, confirmed, active, reminder_sent, expired, disconnected)
- connected_at (TIMESTAMP, NULL)
- confirmed_at (TIMESTAMP, NULL)
- expires_at (TIMESTAMP, NULL)
- reminder_sent_at (TIMESTAMP, NULL)
- firewall_rule_id (VARCHAR(100), NULL)
- created_at (TIMESTAMP)

registration_requests (Запросы на регистрацию)
- id (PK, UUID)
- user_id (FK -> users.id)
- status (ENUM: pending, approved, rejected)
- requested_at (TIMESTAMP)
- reviewed_by (FK -> admins.id, NULL)
- reviewed_at (TIMESTAMP, NULL)
- rejection_reason (TEXT, NULL)

mikrotik_configs (Конфигурации MikroTik)
- id (PK, UUID)
- name (VARCHAR(100))
- host (VARCHAR(255))
- port (INTEGER, default 22)
- username (VARCHAR(100))
- password (VARCHAR(255)) - зашифровано
- ssh_key_path (VARCHAR(500), NULL)
- connection_type (ENUM: ssh_password, ssh_key)
- is_active (BOOLEAN)
- created_at (TIMESTAMP)
- last_connection_test (TIMESTAMP, NULL)

settings (Системные настройки)
- id (PK, UUID)
- key (VARCHAR(100), UNIQUE)
- value (TEXT)
- category (VARCHAR(50))
- description (TEXT)
- is_encrypted (BOOLEAN)

user_settings (Настройки пользователей)
- id (PK, UUID)
- user_id (FK -> users.id)
- firewall_rule_comment (VARCHAR(255))
- reminder_interval_hours (INTEGER, default 6)
- custom_notification_text (TEXT, NULL)

audit_logs (Журнал аудита)
- id (PK, UUID)
- user_id (FK -> users.id, NULL)
- admin_id (FK -> admins.id, NULL)
- action (VARCHAR(100))
- entity_type (VARCHAR(50))
- entity_id (UUID)
- details (TEXT) - JSON данные
- ip_address (VARCHAR(45))
- created_at (TIMESTAMP)

================================================================================
6. API ENDPOINTS
================================================================================

6.1 Аутентификация:
POST   /api/auth/login              - Вход администратора
POST   /api/auth/logout             - Выход
POST   /api/auth/refresh            - Обновление токена
GET    /api/auth/me                 - Текущий пользователь

6.2 Пользователи:
GET    /api/users                   - Список пользователей (с фильтрами)
GET    /api/users/{id}              - Детали пользователя
PUT    /api/users/{id}              - Обновление пользователя
DELETE /api/users/{id}              - Удаление пользователя
GET    /api/users/{id}/sessions     - История сессий пользователя
PUT    /api/users/{id}/status       - Изменение статуса

6.3 Запросы на регистрацию:
GET    /api/registration-requests   - Список запросов
GET    /api/registration-requests/{id} - Детали запроса
POST   /api/registration-requests/{id}/approve - Одобрить
POST   /api/registration-requests/{id}/reject  - Отклонить

6.4 VPN Сессии:
GET    /api/vpn-sessions            - Список сессий (с фильтрами)
GET    /api/vpn-sessions/{id}       - Детали сессии
POST   /api/vpn-sessions/{id}/disconnect - Принудительное отключение
GET    /api/vpn-sessions/active     - Активные сессии

6.5 Настройки:
GET    /api/settings                - Все настройки
GET    /api/settings/{category}     - Настройки категории
PUT    /api/settings/{key}          - Обновление настройки
GET    /api/settings/user/{user_id} - Настройки пользователя
PUT    /api/settings/user/{user_id} - Обновление настроек пользователя

6.6 MikroTik:
GET    /api/mikrotik/configs        - Список конфигураций
POST   /api/mikrotik/configs        - Добавить конфигурацию
PUT    /api/mikrotik/configs/{id}   - Обновить конфигурацию
DELETE /api/mikrotik/configs/{id}   - Удалить конфигурацию
POST   /api/mikrotik/configs/{id}/test - Тест подключения
GET    /api/mikrotik/users          - Список пользователей MikroTik
GET    /api/mikrotik/firewall-rules - Список правил firewall

6.7 Аудит:
GET    /api/audit-logs              - Журнал аудита (с фильтрами)

6.8 Статистика:
GET    /api/stats/overview          - Общая статистика
GET    /api/stats/users             - Статистика по пользователям
GET    /api/stats/sessions          - Статистика по сессиям

6.9 База данных:
GET    /api/database/backup         - Скачать резервную копию базы данных
POST   /api/database/restore        - Загрузить и восстановить базу данных
POST   /api/database/verify         - Проверить целостность базы данных
GET    /api/database/info           - Информация о базе данных (размер, версия)

6.10 Мастер настройки:
GET    /api/setup-wizard/status     - Статус первоначальной настройки
GET    /api/setup-wizard/steps      - Список шагов мастера
GET    /api/setup-wizard/step/{step_id} - Информация о конкретном шаге
POST   /api/setup-wizard/step/{step_id}/complete - Завершить шаг
POST   /api/setup-wizard/restart    - Перезапустить мастер настройки
POST   /api/setup-wizard/complete   - Завершить мастер настройки

================================================================================
7. TELEGRAM BOT КОМАНДЫ И CALLBACK'И
================================================================================

7.1 Команды:
/start           - Приветствие и главное меню
/register        - Регистрация нового пользователя
/connect         - Запрос на подключение к VPN
/disconnect      - Отключение от VPN
/status          - Статус текущей сессии
/help            - Справка

7.2 Callback кнопки:
- register_confirm       - Подтверждение регистрации
- register_cancel        - Отмена регистрации
- vpn_connect            - Запрос подключения
- vpn_confirm_yes        - Подтверждение подключения
- vpn_confirm_no         - Отклонение подключения
- vpn_continue_yes       - Продолжить работу в VPN
- vpn_continue_no        - Отключиться от VPN
- vpn_disconnect         - Отключиться от VPN

7.3 Состояния (FSM):
- registration: ожидание данных пользователя
- vpn_request: ожидание подключения пользователя
- vpn_confirmation: ожидание подтверждения подключения
- vpn_active: активная сессия

================================================================================
8. ВЗАИМОДЕЙСТВИЕ С MIKROTIK
================================================================================

8.1 Подключение:
- Поддержка SSH (логин/пароль или SSH ключ)
- Поддержка REST API (если доступен)
- Пул соединений для оптимизации

8.2 Управление пользователями:
- Создание пользователя в User Manager
- Удаление пользователя
- Активация/деактивация пользователя
- Генерация пароля
- Получение списка активных пользователей
- Получение информации о конкретном пользователе

8.3 Управление Firewall:
- Поиск правил по комментарию
- Включение/выключение правил
- Добавление правил (если нужно)
- Получение списка правил
- Связывание правил с пользователями

8.4 Мониторинг:
- Отслеживание активных VPN подключений
- Получение логов подключений
- Проверка статуса пользователей
- Мониторинг правил firewall

8.5 Безопасность:
- Хранение учетных данных в зашифрованном виде
- Использование SSH ключей предпочтительнее паролей
- Ограничение доступа по IP (если возможно)
- Логирование всех операций

================================================================================
9. НАСТРОЙКИ ДЛЯ АДМИНИСТРАТОРА
================================================================================

9.1 ОБЩИЕ НАСТРОЙКИ СИСТЕМЫ

9.1.1 Основные параметры:
- Название системы
- Логотип системы (загрузка изображения)
- Язык интерфейса (ru, en, и др.)
- Часовой пояс
- Формат даты и времени

9.1.2 Безопасность:
- Время жизни JWT токена (по умолчанию 24 часа)
- Время жизни refresh токена (по умолчанию 7 дней)
- Минимальная длина пароля администратора
- Требования к сложности пароля
- Максимальное количество неудачных попыток входа
- Время блокировки после неудачных попыток
- Обязательная двухфакторная аутентификация для администраторов (опционально)

9.1.3 Уведомления администратора:
- Email для уведомлений администратора
- Telegram ID администратора для уведомлений
- Уведомления о новых запросах на регистрацию (вкл/выкл)
- Уведомления о подключениях к VPN (вкл/выкл)
- Уведомления об отключениях (вкл/выкл)
- Уведомления об ошибках системы (вкл/выкл)

================================================================================

9.2 НАСТРОЙКИ TELEGRAM BOT

9.2.1 Основные:
- Telegram Bot Token
- Имя бота (отображаемое)
- Username бота
- Описание бота

9.2.2 Тексты сообщений:
- Приветственное сообщение (/start)
- Текст кнопки регистрации
- Текст запроса данных при регистрации
- Сообщение об успешной регистрации
- Сообщение об отклонении регистрации
- Текст кнопки подключения к VPN
- Сообщение с данными для подключения
- Сообщение подтверждения подключения: "Это вы подключились? [Имя]"
- Текст кнопки "Да" при подтверждении
- Текст кнопки "Нет" при подтверждении
- Сообщение об успешной активации VPN
- Сообщение об отклонении подключения
- Сообщение напоминания: "Хотите продолжить работу в VPN? [Имя]"
- Текст кнопки "Да, продолжить"
- Текст кнопки "Нет, отключиться"
- Сообщение о продлении сессии
- Сообщение об отключении
- Сообщение об ошибке

9.2.3 Визуальное оформление (для Mini-App, если используется):
- Основной цвет кнопок (hex)
- Цвет кнопок при наведении (hex)
- Цвет текста кнопок (hex)
- Цвет фона (hex)
- Цвет текста (hex)
- Цвет акцентов (hex)
- Цвет успешных операций (hex)
- Цвет ошибок (hex)
- Цвет предупреждений (hex)
- Шрифт (выбор из списка)
- Размер шрифта (px)
- Скругление углов кнопок (px)
- Тень кнопок (вкл/выкл)
- Анимации (вкл/выкл)

9.2.4 Логика работы:
- Время ожидания подтверждения подключения (секунды, по умолчанию 300)
- Автоматическое отключение при отсутствии ответа (вкл/выкл)
- Интервал напоминания о продолжении работы (часы, 4-8, по умолчанию 6)
- Время ожидания ответа на напоминание (минуты, по умолчанию 10)
- Автоматическое отключение при отсутствии ответа на напоминание (вкл/выкл)
- Интервал проверки подключений к VPN (секунды)
- Максимальное количество одновременных сессий на пользователя

================================================================================

9.3 НАСТРОЙКИ MIKROTIK

9.3.1 Подключение:
- Имя конфигурации (для множественных роутеров)
- IP адрес или домен роутера
- Порт SSH (по умолчанию 22)
- Имя пользователя
- Пароль (сохранен в зашифрованном виде)
- Путь к SSH ключу (если используется)
- Тип подключения (SSH пароль / SSH ключ / REST API)
- Использовать как основной (если несколько роутеров)
- Таймаут подключения (секунды)
- Количество попыток переподключения

9.3.2 User Manager:
- Префикс для имен пользователей (по умолчанию "vpn_user_")
- Генерация паролей (длина, сложность)
- Профиль пользователя в MikroTik (если используется)
- Группа пользователей в MikroTik (если используется)
- Автоматическое удаление неиспользуемых пользователей через N дней
- Синхронизация с системой при старте

9.3.3 Firewall правила:
- Шаблон комментария для поиска правил (по умолчанию "vpn_user_{username}")
- Возможность настройки комментария для каждого пользователя индивидуально
- Цепочка (chain) для правил (input, forward, output)
- Действие правила (accept, reject, drop)
- Порядок правил (до или после других правил)
- Автоматическое создание правил при первом подключении (вкл/выкл)
- Шаблон правила для создания (JSON/Roscript)

9.3.4 Мониторинг:
- Интервал проверки активных подключений (секунды)
- Интервал проверки правил firewall (секунды)
- Максимальное время для обнаружения подключения после фактического подключения (секунды)
- Использование логов для обнаружения подключений (вкл/выкл)
- Уровень детализации логов

================================================================================

9.4 НАСТРОЙКИ ПОЛЬЗОВАТЕЛЕЙ (настраиваются для каждого пользователя)

9.4.1 VPN параметры:
- Имя пользователя в MikroTik User Manager
- Комментарий для поиска правила firewall (например: "vpn_user_ivanov")
- Интервал напоминания для этого пользователя (часы, переопределяет глобальное)
- Приоритет подключения

9.4.2 Уведомления:
- Кастомный текст для уведомлений этого пользователя (опционально)
- Отправлять уведомления на Email (вкл/выкл)
- Дополнительный Telegram ID для уведомлений (опционально)

9.4.3 Ограничения:
- Максимальное время сессии (часы, без ограничения = 0)
- Максимальное количество одновременных сессий
- Разрешенные IP адреса для подключения (whitelist)
- Запрещенные IP адреса (blacklist)
- Разрешенные дни недели для подключения
- Разрешенные часы для подключения (временные окна)

9.4.4 Статусы и разрешения:
- Статус пользователя (pending, approved, rejected, active, inactive)
- Разрешить доступ к VPN (вкл/выкл)
- Автоматическое одобрение подключений (вкл/выкл)
- Требовать подтверждение от администратора для каждого подключения (вкл/выкл)

================================================================================

9.5 НАСТРОЙКИ ФОРМ И ПОЛЕЙ

9.5.1 Регистрация:
- Обязательные поля при регистрации (ФИО, телефон, email, комментарий)
- Опциональные поля
- Валидация формата телефона
- Валидация формата email
- Минимальная/максимальная длина полей
- Регулярные выражения для валидации
- Кастомные сообщения об ошибках валидации

9.5.2 Веб-интерфейс администратора:
- Количество записей на странице (пагинация)
- Сортировка по умолчанию
- Фильтры по умолчанию
- Экспорт данных (CSV, JSON, Excel)
- Автосохранение изменений (вкл/выкл)

================================================================================

9.6 НАСТРОЙКИ ЛОГИРОВАНИЯ И МОНИТОРИНГА

9.6.1 Логирование:
- Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- Формат логов (текст, JSON)
- Ротация логов (размер файла, количество файлов)
- Хранение логов (дни)
- Логирование всех операций с MikroTik (вкл/выкл)
- Логирование всех уведомлений (вкл/выкл)
- Логирование всех действий администраторов (вкл/выкл)

9.6.2 Мониторинг:
- Интервал проверки здоровья системы (секунды)
- Интервал проверки подключения к MikroTik (секунды)
- Интервал проверки подключения к Telegram API (секунды)
- Интервал проверки подключения к базе данных (секунды)
- Email для отправки уведомлений о проблемах
- Telegram для отправки уведомлений о проблемах
- Критические события для уведомления (выбор из списка)

================================================================================

9.7 НАСТРОЙКИ БАЗЫ ДАННЫХ

9.6.1 Резервное копирование:
- Автоматическое резервное копирование (вкл/выкл)
- Интервал резервного копирования (часы)
- Время начала резервного копирования
- Хранение резервных копий (дни)
- Путь для сохранения резервных копий
- Компрессия резервных копий (вкл/выкл)
- Резервное копирование SQLite (копирование файла .db с использованием WAL mode)
- Автоматическое создание резервных копий перед критическими операциями (вкл/выкл)

9.6.2 Очистка:
- Автоматическая очистка старых сессий (вкл/выкл)
- Удалять сессии старше N дней
- Автоматическая очистка логов аудита (вкл/выкл)
- Удалять логи аудита старше N дней
- Автоматическая очистка старых уведомлений (вкл/выкл)

================================================================================

9.8 НАСТРОЙКИ ВЕБ-ИНТЕРФЕЙСА АДМИНИСТРАТОРА

9.8.1 Внешний вид:
- Тема оформления (светлая, темная, автоматическая)
- Основной цвет (hex)
- Цвет акцентов (hex)
- Шрифт интерфейса
- Размер шрифта
- Компактный/обычный режим
- Показывать анимации (вкл/выкл)

9.8.2 Функциональность:
- Автоматическое обновление данных (вкл/выкл)
- Интервал обновления (секунды)
- Показывать уведомления в интерфейсе (вкл/выкл)
- Звуковые уведомления (вкл/выкл)
- Показывать статистику на главной странице (вкл/выкл)
- Показывать активные сессии на главной странице (вкл/выкл)
- Показывать последние события на главной странице (вкл/выкл)

================================================================================

10. СТРАНИЦЫ ВЕБ-ИНТЕРФЕЙСА АДМИНИСТРАТОРА
================================================================================

10.1 Главная страница (Dashboard):
- Общая статистика (всего пользователей, активных сессий, запросов на регистрацию)
- Активные VPN сессии (список с возможностью отключения)
- Последние события (лента активности)
- Графики подключений (за день, неделю, месяц)
- Уведомления и предупреждения

10.2 Пользователи:
- Список всех пользователей (таблица с фильтрами и поиском)
- Детали пользователя (просмотр и редактирование)
- История сессий пользователя
- Настройки пользователя

10.3 Запросы на регистрацию:
- Список запросов (pending, approved, rejected)
- Детали запроса
- Одобрение/отклонение
- Массовые операции

10.4 VPN Сессии:
- Активные сессии
- История сессий (с фильтрами)
- Детали сессии
- Принудительное отключение

10.5 Настройки:
- Категории настроек (вкладки или боковое меню)
- Редактирование настроек
- Экспорт/импорт настроек
- Сброс настроек к значениям по умолчанию

10.6 MikroTik:
- Список конфигураций роутеров
- Добавление/редактирование конфигурации
- Тест подключения
- Просмотр пользователей MikroTik
- Просмотр правил firewall
- Синхронизация данных

10.7 Журнал аудита:
- Фильтры по пользователю, действию, дате
- Поиск
- Экспорт логов

10.8 Статистика:
- Графики и диаграммы
- Экспорт отчетов
- Периоды (день, неделя, месяц, год)

10.9 Профиль администратора:
- Изменение пароля
- Настройки уведомлений
- Настройки интерфейса

10.10 Управление базой данных:
- Скачивание резервной копии базы данных
- Загрузка и восстановление базы данных из файла
- Информация о базе данных (размер, версия, количество записей)
- Проверка целостности базы данных
- Автоматические резервные копии (настройка и просмотр)

10.11 Мастер настройки (Setup Wizard):
- Автоматический запуск при первом входе в систему
- Пошаговое руководство по настройке системы
- Подсказки и инструкции на каждом шаге
- Валидация настроек на каждом шаге
- Возможность пропустить шаги (но с предупреждением)
- Возможность запустить мастер настройки в любой момент из меню
- Индикация прогресса настройки
- Сохранение промежуточного прогресса

================================================================================
11. БЕЗОПАСНОСТЬ
================================================================================

11.1 Аутентификация и авторизация:
- JWT токены с коротким временем жизни
- Refresh токены с длительным временем жизни
- Хеширование паролей (bcrypt или argon2)
- Защита от brute-force атак
- Rate limiting для API
- CORS настройки
- HTTPS обязателен для production

11.2 Защита данных:
- Шифрование чувствительных данных в БД (пароли MikroTik, токены)
- Безопасное хранение SSH ключей
- Минимизация времени хранения паролей VPN
- Очистка логов от чувствительных данных

11.3 Защита от атак:
- SQL injection защита (ORM)
- XSS защита (валидация и санитизация)
- CSRF токены
- Защита от DDoS (rate limiting)
- Валидация всех входных данных

11.4 Аудит и мониторинг:
- Логирование всех критических операций
- Отслеживание подозрительной активности
- Уведомления о безопасности
- Регулярные проверки безопасности

================================================================================
12. ОБРАБОТКА ОШИБОК
================================================================================

12.1 Типы ошибок:
- Ошибки подключения к MikroTik
- Ошибки подключения к Telegram API
- Ошибки базы данных
- Ошибки валидации данных
- Ошибки авторизации
- Таймауты операций

12.2 Стратегии обработки:
- Повторные попытки с экспоненциальной задержкой
- Fallback механизмы
- Уведомления администратору
- Логирование всех ошибок
- Понятные сообщения пользователям

================================================================================
13. ТЕСТИРОВАНИЕ
================================================================================

13.1 Unit тесты:
- Тесты для всех сервисов
- Тесты для API endpoints
- Тесты для бизнес-логики

13.2 Integration тесты:
- Тесты взаимодействия с MikroTik (mock)
- Тесты взаимодействия с Telegram (mock)
- Тесты базы данных

13.3 E2E тесты:
- Полный цикл регистрации и подключения
- Тесты веб-интерфейса

================================================================================
14. РАЗВЕРТЫВАНИЕ
================================================================================

14.1 Требования к системе:
- ОС: Debian 12 (Bookworm) или Debian 13 (Trixie)
- Python 3.11+ (входит в Debian 12+)
- SQLite 3 (встроен в Python, не требует отдельной установки)
- Nginx (опционально, для reverse proxy)
- Доступ к интернету (для Telegram API)
- Доступ к MikroTik роутеру по SSH
- Минимум 512MB RAM (рекомендуется 1GB+)
- Минимум 1GB свободного места на диске

14.2 Установка:
- Проект содержит все необходимые зависимости
- Клонирование репозитория или распаковка архива
- Установка системных зависимостей через скрипт install.sh
- Установка Python зависимостей из requirements.txt (включен в проект)
- Установка Frontend зависимостей из package.json (включен в проект)
- Настройка переменных окружения через .env.example
- Инициализация базы данных SQLite (автоматически при первом запуске)
- Запуск миграций (автоматически при первом запуске)
- Настройка первого администратора через скрипт setup_admin.sh
- Запуск приложения через скрипт start.sh или systemd service

14.2.1 Автоматическая установка:
Проект содержит скрипт автоматической установки install.sh, который:
- Проверяет версию ОС (Debian 12-13)
- Устанавливает необходимые системные пакеты
- Создает виртуальное окружение Python
- Устанавливает все Python зависимости
- Устанавливает все Node.js зависимости (если требуется frontend сборка)
- Создает необходимые директории
- Настраивает права доступа
- Создает systemd service файл (опционально)

14.2.2 Первоначальная настройка через мастер настройки:
После установки и первого запуска приложения, при первом входе в веб-интерфейс 
автоматически запускается мастер настройки (Setup Wizard), который помогает 
настроить систему пошагово:

Шаг 1: Основная информация
- Название системы
- Язык интерфейса
- Часовой пояс
- Email администратора

Шаг 2: Безопасность
- Генерация секретного ключа (или использование существующего)
- Настройка JWT токенов
- Настройка пароля администратора

Шаг 3: Telegram Bot
- Настройка Telegram Bot Token
- Инструкции по созданию бота (ссылки, скриншоты)
- Тест подключения к Telegram API

Шаг 4: MikroTik
- Настройка подключения к MikroTik роутеру
- Инструкции по настройке доступа (SSH, ключи)
- Тест подключения к MikroTik
- Настройка параметров User Manager
- Настройка параметров Firewall правил

Шаг 5: Уведомления
- Настройка уведомлений администратору
- Telegram ID администратора для уведомлений
- Email для уведомлений

Шаг 6: Завершение
- Проверка всех настроек
- Создание первого администратора (если не создан)
- Запуск сервисов

После завершения мастера настройки система готова к работе.
Мастер настройки можно запустить в любой момент из меню "Настройки" -> "Мастер настройки"

14.3 Обслуживание:
- Резервное копирование базы данных SQLite (копирование файла базы данных)
- Автоматическое резервное копирование через скрипт backup_db.sh
- Мониторинг логов
- Обновление системы через скрипт update.sh
- Проверка здоровья системы
- Оптимизация базы данных SQLite (VACUUM) через cron или скрипт

14.4 Структура зависимостей проекта:
Проект содержит все необходимые зависимости для развертывания:

14.4.1 Python зависимости:
- Файл requirements.txt содержит все необходимые Python пакеты
- Версии пакетов зафиксированы для стабильности
- Автоматическая установка через: pip install -r requirements.txt
- Все зависимости устанавливаются в виртуальное окружение

14.4.2 Frontend зависимости:
- Файл package.json содержит все необходимые npm пакеты
- Файл package-lock.json фиксирует точные версии
- Автоматическая установка через: npm install
- Frontend может быть собран в статические файлы для production

14.4.3 Системные зависимости:
- Список системных пакетов в install.sh
- Автоматическая установка через скрипт install.sh
- Проверка наличия необходимых пакетов
- Установка только недостающих компонентов

14.4.4 Конфигурационные файлы:
- .env.example - шаблон переменных окружения
- config/settings.default.yaml - настройки по умолчанию
- Все шаблоны включены в проект

================================================================================
15. МАСТЕР НАСТРОЙКИ (SETUP WIZARD)
================================================================================

15.1 Цель мастера настройки:
Мастер настройки помогает администратору настроить систему после первого 
развертывания, предоставляя пошаговое руководство с подсказками и инструкциями.

15.2 Режимы работы:
- Автоматический запуск: при первом входе в систему, если настройка не завершена
- Ручной запуск: из меню "Настройки" -> "Мастер настройки" в любой момент
- Перезапуск: возможность начать настройку заново

15.3 Шаги мастера настройки:

15.3.1 Шаг 1: Добро пожаловать
- Приветственное сообщение
- Информация о системе
- Описание процесса настройки
- Кнопка "Начать настройку"

15.3.2 Шаг 2: Основная информация
- Название системы (по умолчанию: "MikroTik 2FA VPN System")
- Логотип системы (опционально, загрузка файла)
- Язык интерфейса (выбор из списка: ru, en и др.)
- Часовой пояс (автоматическое определение или выбор вручную)
- Email администратора (для уведомлений)
- Валидация: проверка формата email, выбор языка из списка

15.3.3 Шаг 3: Безопасность
- Генерация секретного ключа (автоматическая с возможностью ручной установки)
  - Кнопка "Сгенерировать новый ключ"
  - Показать/скрыть ключ
  - Предупреждение о необходимости сохранить ключ
- Настройка JWT токенов:
  - Время жизни access token (по умолчанию: 1440 минут)
  - Время жизни refresh token (по умолчанию: 7 дней)
- Создание первого администратора:
  - Имя пользователя (username)
  - Email
  - Пароль (с требованиями к сложности)
  - Подтверждение пароля
  - Полное имя
- Валидация: проверка сложности пароля, соответствие паролей

15.3.4 Шаг 4: Telegram Bot
- Информация о необходимости создания Telegram бота
- Инструкции по созданию бота:
  - Ссылка на @BotFather
  - Скриншоты или видео-инструкция
  - Пошаговое руководство
- Настройка Telegram Bot Token:
  - Поле для ввода токена
  - Кнопка "Проверить токен" (тест подключения)
  - Сообщение об успехе/ошибке проверки
- Настройка основных параметров бота (опционально):
  - Имя бота (для отображения)
  - Описание бота
- Валидация: проверка формата токена, тест подключения к Telegram API

15.3.5 Шаг 5: MikroTik Router
- Информация о подключении к MikroTik
- Выбор метода подключения:
  - SSH с паролем
  - SSH с ключом
  - REST API (если доступен)
- Настройка подключения:
  - IP адрес или домен роутера
  - Порт SSH (по умолчанию: 22)
  - Имя пользователя
  - Пароль или путь к SSH ключу
- Инструкции по настройке доступа на роутере:
  - Создание пользователя для системы
  - Настройка прав доступа
  - Настройка SSH ключей (если используется)
  - Ссылки на документацию MikroTik
- Тест подключения:
  - Кнопка "Тестировать подключение"
  - Индикатор состояния подключения
  - Сообщения об ошибках с подсказками
- Настройка параметров User Manager:
  - Префикс для имен пользователей (по умолчанию: "vpn_user_")
  - Шаблон генерации паролей
  - Профиль пользователя (если используется)
- Настройка параметров Firewall:
  - Шаблон комментария для поиска правил
  - Цепочка для правил (input, forward, output)
  - Действие правила (accept, reject, drop)
- Валидация: проверка формата IP, тест подключения к MikroTik

15.3.6 Шаг 6: Уведомления и мониторинг
- Настройка уведомлений администратору:
  - Email для уведомлений (если отличается от основного)
  - Telegram ID администратора для уведомлений
  - Типы уведомлений (выбор из списка):
    * Новые запросы на регистрацию
    * Подключения к VPN
    * Отключения от VPN
    * Ошибки системы
- Настройка мониторинга:
  - Интервал проверки здоровья системы
  - Критические события для уведомлений

15.3.7 Шаг 7: Дополнительные настройки (опционально)
- Настройка веб-интерфейса:
  - Тема оформления (светлая, темная)
  - Основные цвета
- Настройка логирования:
  - Уровень логирования
  - Формат логов
- Настройка резервного копирования:
  - Автоматическое резервное копирование
  - Интервал резервного копирования
  - Хранение резервных копий

15.3.8 Шаг 8: Проверка и завершение
- Сводка всех настроек:
  - Таблица со всеми настройками
  - Возможность вернуться к любому шагу для изменения
  - Кнопки "Изменить" для каждого шага
- Проверка готовности системы:
  - Проверка всех подключений (Telegram, MikroTik)
  - Проверка базы данных
  - Проверка необходимых настроек
  - Список предупреждений (если есть)
- Кнопка "Завершить настройку":
  - Сохранение всех настроек
  - Создание первого администратора (если не создан)
  - Инициализация базы данных (если необходимо)
  - Запуск всех сервисов
  - Перенаправление на главную страницу

15.4 Функции мастера настройки:
- Прогресс настройки: индикатор прогресса (шаг X из Y)
- Навигация между шагами:
  - Кнопка "Назад" (кроме первого шага)
  - Кнопка "Далее" (с валидацией текущего шага)
  - Кнопка "Пропустить" (для опциональных шагов, с предупреждением)
  - Кнопка "Сохранить и выйти" (сохранение промежуточного прогресса)
- Валидация на каждом шаге:
  - Проверка обязательных полей
  - Проверка форматов данных
  - Проверка подключений (Telegram, MikroTik)
  - Сообщения об ошибках с подсказками по исправлению
- Подсказки и помощь:
  - Иконки "?" с подсказками при наведении
  - Кнопка "Помощь" на каждом шаге
  - Ссылки на документацию
  - Примеры заполнения полей
- Сохранение прогресса:
  - Автоматическое сохранение при переходе между шагами
  - Возможность продолжить настройку позже
  - Индикация незавершенных шагов

15.5 Определение завершенности настройки:
Система определяет, что настройка завершена, если:
- Создан хотя бы один администратор
- Настроен Telegram Bot Token
- Настроено подключение к MikroTik
- Сохранены основные настройки безопасности

После завершения настройки мастер не запускается автоматически при входе.
Администратор может запустить мастер настройки вручную в любой момент.

15.6 API для мастера настройки:
Все действия мастера настройки доступны через REST API для интеграции
с веб-интерфейсом и возможности программного управления настройкой.

================================================================================
16. УПРАВЛЕНИЕ БАЗОЙ ДАННЫХ
================================================================================

16.1 Скачивание базы данных:
- Доступно из веб-интерфейса в разделе "Настройки" -> "База данных"
- Кнопка "Скачать резервную копию"
- Создание резервной копии перед скачиванием
- Скачивание файла .db с текущей датой и временем в имени
- Компрессия в .zip или .tar.gz (опционально)
- Логирование операции в журнал аудита

16.2 Загрузка базы данных:
- Доступно из веб-интерфейса в разделе "Настройки" -> "База данных"
- Кнопка "Загрузить резервную копию"
- Выбор файла .db или архива (.zip, .tar.gz)
- Проверка формата файла перед загрузкой
- Проверка версии базы данных (совместимость)
- Создание резервной копии текущей базы перед загрузкой
- Предупреждение о замене текущей базы данных
- Подтверждение операции
- Валидация целостности загруженной базы
- Перезапуск сервисов после загрузки (опционально)
- Логирование операции в журнал аудита

16.3 Безопасность:
- Доступ только для супер-администраторов
- Проверка целостности файла перед загрузкой
- Шифрование чувствительных данных в базе
- Валидация версии базы данных
- Автоматическое создание резервных копий перед операциями

16.4 Информация о базе данных:
- Размер файла базы данных
- Версия схемы базы данных
- Количество записей в каждой таблице
- Дата последнего резервного копирования
- Дата последнего изменения
- Статистика использования дискового пространства

16.5 Автоматические резервные копии:
- Настройка через веб-интерфейс
- Интервал резервного копирования (часы, дни)
- Время начала резервного копирования
- Хранение резервных копий (количество, дни)
- Путь для сохранения резервных копий
- Компрессия резервных копий
- Уведомления об успехе/ошибках резервного копирования

================================================================================
17. ДОКУМЕНТАЦИЯ
================================================================================

15.1 Документация для администратора:
- Руководство по установке
- Руководство по настройке
- Руководство по использованию
- FAQ
- Troubleshooting

15.2 Документация для пользователей:
- Инструкция по регистрации
- Инструкция по подключению к VPN
- FAQ для пользователей

15.3 Техническая документация:
- API документация
- Архитектура системы
- Схема базы данных
- Протоколы взаимодействия

================================================================================
18. БУДУЩИЕ УЛУЧШЕНИЯ (Roadmap)
================================================================================

- Поддержка нескольких MikroTik роутеров одновременно
- Балансировка нагрузки между роутерами
- Интеграция с другими системами аутентификации (LDAP, AD)
- Поддержка других типов VPN (WireGuard, OpenVPN)
- Мобильное приложение
- Расширенная аналитика
- Автоматизация на основе правил
- Webhook'и для интеграций

================================================================================
КОНЕЦ ПЛАНА
================================================================================
