# Полное руководство по установке

## Автоматическая установка (рекомендуется)

Скрипт `scripts/install.sh` полностью автоматизирует установку, сборку, запуск и настройку автозагрузки.

### Вариант 1: Установка из Git репозитория

```bash
sudo GIT_REPO="https://github.com/ваш-username/mikrotik-2fa-vpn.git" bash scripts/install.sh
```

### Вариант 2: Установка из локальной директории

```bash
cd /path/to/mikrotik-2fa-vpn
sudo bash scripts/install.sh
```

### Параметры установки

Скрипт поддерживает следующие переменные окружения:

```bash
# Директория установки (по умолчанию: /opt/mikrotik-2fa-vpn)
export INSTALL_DIR="/opt/mikrotik-2fa-vpn"

# Git репозиторий (если не указан, используется локальный проект)
export GIT_REPO="https://github.com/ваш-username/mikrotik-2fa-vpn.git"

# Ветка для клонирования (по умолчанию: main)
export GIT_BRANCH="main"

# Системный пользователь (по умолчанию: mikrotik-2fa)
export SYSTEM_USER="mikrotik-2fa"

# Создать systemd service (по умолчанию: true)
export CREATE_SYSTEMD_SERVICE="true"

# Автоматически запустить сервис (по умолчанию: true)
export AUTO_START="true"

# Создать администратора (по умолчанию: true)
export CREATE_ADMIN="true"

# Параметры администратора
export ADMIN_USERNAME="admin"
export ADMIN_EMAIL="admin@example.com"
export ADMIN_PASSWORD="your_password"  # Если не указан, будет сгенерирован

# Неинтерактивный режим (по умолчанию: false)
export NON_INTERACTIVE="true"
```

### Пример полной установки с параметрами

```bash
sudo \
  GIT_REPO="https://github.com/ваш-username/mikrotik-2fa-vpn.git" \
  INSTALL_DIR="/opt/mikrotik-2fa-vpn" \
  ADMIN_USERNAME="admin" \
  ADMIN_PASSWORD="SecurePassword123" \
  AUTO_START="true" \
  bash scripts/install.sh
```

## Что делает скрипт установки

Скрипт выполняет следующие шаги автоматически:

1. ✅ **Проверка системных зависимостей**
   - Python 3.8+ (устанавливает если отсутствует)
   - Node.js 20+ (устанавливает если отсутствует)
   - Системные пакеты (python3-venv, build-essential, rust, cargo и др.)

2. ✅ **Определение источника проекта**
   - Поддержка установки из Git репозитория
   - Поддержка локальной установки из текущей директории

3. ✅ **Создание системного пользователя**
   - Создает пользователя для запуска сервиса
   - Настраивает домашнюю директорию

4. ✅ **Создание виртуального окружения Python**
   - Создает изолированное окружение
   - Обновляет pip, setuptools, wheel

5. ✅ **Установка Python зависимостей**
   - Устанавливает все зависимости из requirements.txt
   - Исправляет проблемы совместимости (bcrypt)

6. ✅ **Настройка конфигурации**
   - Создает .env файл
   - Генерирует SECRET_KEY, JWT_SECRET_KEY, ENCRYPTION_KEY
   - Настраивает базовые параметры

7. ✅ **Создание директорий**
   - data, data/backups, logs, frontend/dist

8. ✅ **Инициализация базы данных**
   - Создает все таблицы
   - Инициализирует структуру БД

9. ✅ **Создание администратора**
   - Создает первого администратора с правами super-admin
   - Генерирует случайный пароль если не указан
   - Сохраняет учетные данные в файл

10. ✅ **Установка Frontend зависимостей**
    - Устанавливает все npm пакеты
    - Поддерживает recharts, xlsx и другие зависимости

11. ✅ **Сборка Frontend**
    - Собирает React приложение
    - Создает оптимизированные ассеты

12. ✅ **Настройка прав доступа**
    - Устанавливает правильные права на файлы и директории
    - Настраивает безопасность .env файла

13. ✅ **Создание systemd service**
    - Создает unit файл для systemd
    - Настраивает автозагрузку

14. ✅ **Запуск сервиса**
    - Запускает backend через systemd
    - Проверяет статус запуска

15. ✅ **Проверка работоспособности**
    - Проверяет health endpoint
    - Убеждается что сервис отвечает

## Проверки в скрипте

Скрипт включает множество проверок:

- ✅ Проверка прав root
- ✅ Проверка версии Python (>= 3.8)
- ✅ Проверка установки системных пакетов
- ✅ Проверка наличия проекта (локальный или git)
- ✅ Проверка существования виртуального окружения
- ✅ Проверка установки зависимостей
- ✅ Проверка инициализации БД
- ✅ Проверка создания администратора
- ✅ Проверка сборки frontend
- ✅ Проверка создания systemd service
- ✅ Проверка запуска сервиса
- ✅ Проверка health endpoint

## Результат установки

После успешной установки:

1. **Проект установлен** в указанную директорию (по умолчанию `/opt/mikrotik-2fa-vpn`)
2. **База данных инициализирована** со всеми таблицами
3. **Администратор создан** с учетными данными
4. **Frontend собран** и готов к использованию
5. **Systemd service создан** и настроен
6. **Сервис запущен** и работает
7. **Автозагрузка включена** (если AUTO_START=true)

## Учетные данные

После установки учетные данные администратора сохраняются в файл:
```
<PROJECT_DIR>/.admin_credentials.txt
```

**ВАЖНО:** Сохраните данные в безопасном месте и удалите этот файл!

## Следующие шаги после установки

### ⚠️ ВАЖНО: Вся настройка выполняется через веб-интерфейс!

После установки выполните следующие шаги:

1. **Откройте веб-интерфейс:**
   ```
   http://localhost:8000
   ```

2. **Войдите с учетными данными администратора:**
   - Username: `admin` (или указанный при установке)
   - Password: см. файл `.admin_credentials.txt` в директории проекта

3. **Пройдите мастер настройки:**
   - При первом входе автоматически откроется мастер настройки
   - Или откройте "Мастер настройки" из меню
   - Мастер включает настройку:
     - Telegram Bot (токен от @BotFather)
     - MikroTik роутера (параметры подключения)
     - Безопасности и первого администратора
     - Уведомлений и дополнительных параметров

4. **Все настройки сохраняются автоматически:**
   - Настройки сохраняются в базу данных
   - Автоматически синхронизируются с `.env` файлом
   - Применяются без перезапуска (или требуется перезапуск сервиса)

5. **После завершения мастера настройки:**
   - Telegram бот можно запустить через веб-интерфейс (или вручную)
   - Все компоненты готовы к работе

**Примечание:** Ручное редактирование `.env` файла НЕ требуется, так как всё настраивается через веб-интерфейс в мастер настройки!

## Управление сервисом

```bash
# Статус
sudo systemctl status mikrotik-2fa-vpn

# Остановка
sudo systemctl stop mikrotik-2fa-vpn

# Запуск
sudo systemctl start mikrotik-2fa-vpn

# Перезапуск
sudo systemctl restart mikrotik-2fa-vpn

# Просмотр логов
sudo journalctl -u mikrotik-2fa-vpn.service -f

# Последние 100 строк логов
sudo journalctl -u mikrotik-2fa-vpn.service -n 100
```

## Устранение проблем

### Сервис не запускается

```bash
# Проверить логи
sudo journalctl -u mikrotik-2fa-vpn.service -n 50

# Проверить конфигурацию
sudo systemctl status mikrotik-2fa-vpn.service

# Проверить права доступа
ls -la /opt/mikrotik-2fa-vpn/.env
```

### База данных заблокирована

```bash
# Найти процессы использующие БД
sudo lsof /opt/mikrotik-2fa-vpn/data/database.db

# Остановить сервис
sudo systemctl stop mikrotik-2fa-vpn
```

### Frontend не собирается

```bash
cd /opt/mikrotik-2fa-vpn/frontend
npm install
npm run build
```

### Переустановка

```bash
# Остановить сервис
sudo systemctl stop mikrotik-2fa-vpn
sudo systemctl disable mikrotik-2fa-vpn

# Удалить service файл
sudo rm /etc/systemd/system/mikrotik-2fa-vpn.service
sudo systemctl daemon-reload

# Удалить директорию проекта (если нужно)
sudo rm -rf /opt/mikrotik-2fa-vpn

# Запустить установку заново
sudo bash scripts/install.sh
```

---

**Скрипт установки полностью автоматизирован и готов к использованию!** ✅
